<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CubeHash WASM â€” Hash Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="loader">
    <div class="loader-progress" id="loaderProgress"></div>
  </div>
  <main class="container">

	<!-- Header -->
  <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h1>CubeHash  <img src="cubehash.png" width="25" height="25"></h1>
    <div class="controls-row" style="margin-top: 1rem;">
      <label for="revision">Revision</label>
      <select id="revision" class="compact-control">
        <option value="3" selected>3</option>
        <option value="2">2</option>
      </select>

      <label for="bits">Bit length</label>
      <input id="bits" type="number" min="8" max="512" step="8" value="256" class="compact-control" />
      <div id="simdSupport" style="margin-left: 1rem;"></div>
    </div>
  </header>

	<!-- Tabs -->
	<div class="tabs">
		<button id="fileTab" class="secondary tab-active">File</button>
		<button id="stringTab" class="secondary">String</button>
	</div>

    <!-- File panel -->
    <section id="fileTabContent" data-panel>
      <input id="file" type="file" />
      <div id="fileInfo"></div>
      <button id="hashFileBtn">
        <span class="btn-text">Hash File</span>
        <div class="progress-fill"></div>
      </button>
    </section>

    <!-- String panel -->
    <section id="stringTabContent" data-panel hidden>
      <label>
        <span>Input text</span>
        <textarea id="inputStr" rows="4" placeholder="Enter text here"></textarea>
      </label>
    </section>

    <div class="tabs">
		  <button class="secondary tab-active">Digest</button>
	  </div>

    <!-- Digest -->
    <section id="digestContent" data-panel>
      <div class="digest-row">
        <pre id="out"></pre>
        <div class="copy-container">
          <button id="copyBtn" title="Copy to clipboard" aria-label="Copy digest">ðŸ“‹</button>
          <span id="copyMsg">Copied!</span>
        </div>
      </div>

      <!-- Perf Info (file mode only) -->
      <div id="perfInfo">
        <div><strong>Time:</strong> <output id="timeMs">â€“</output></div>
        <div><strong>Throughput:</strong> <output id="mbps">â€“</output></div>
      </div>
    </section>
  </main>
  <footer style="display: flex; justify-content: center; margin-top: 1rem;">
    <a href="https://github.com/mcrepeau/cubehash-web" target="_blank">
      <img src="github-mark.png" alt="GitHub Logo" width="20" height="20">
    </a>
  </footer>
<script src="https://unpkg.com/wasm-feature-detect/dist/umd/index.js"></script>
<script type="module">
  async function loadWasm() {
    try {
      // Show loader
      const loaderProgress = document.getElementById("loaderProgress");
      loaderProgress.style.width = "20%"; // Initial progress

      // Check for WASM and SIMD support
      if (typeof WebAssembly === "object") {
        loaderProgress.style.width = "40%"; // Update progress

        const simdSupported = await wasmFeatureDetect.simd();
        const simdSupportElement = document.getElementById("simdSupport");

        if (simdSupported) {
          simdSupportElement.textContent = "SIMD supported âœ…";
          simdSupportElement.style.color = "green";
          const { default: init, WasmCubeHash } = await import(
            "https://cubehash-web.pages.dev/cubehash-wasm/0.2.0/simd/cubehash_wasm.js"
          );
          loaderProgress.style.width = "60%"; // Update progress
          await init();
          window.WasmCubeHash = WasmCubeHash;
        } else {
          simdSupportElement.textContent = "SIMD not supported âŒ";
          simdSupportElement.style.color = "red";
          loaderProgress.style.width = "60%"; // Update progress
          const { default: init, WasmCubeHash } = await import(
            "https://cubehash-web.pages.dev/cubehash-wasm/0.2.0/scalar/cubehash_wasm.js"
          );
          await init();
          window.WasmCubeHash = WasmCubeHash;
        }

        loaderProgress.style.width = "100%"; // Complete progress

        if (typeof main === "function") main();
      } else {
        console.warn("WebAssembly not supported in this browser âŒ");
      }
    } catch (err) {
      console.error("Error loading WASM or detecting features:", err);
    } finally {
      // Hide loader after a short delay to show completion
      setTimeout(() => {
        document.querySelector(".loader").style.display = "none";
      }, 500);
    }
  }

  loadWasm();
</script>
<script src="script.js"></script>
</body>
</html>
